<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Create & Assign Kit | Ez10</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<style>
:root {
  --primary: #4dabf7;
  --danger: #ff4b5c;
  --success: #28a745;
  --choiceA: #ff4b5c;
  --choiceB: #4dabf7;
  --choiceC: #37d67a;
  --choiceD: #f9ca24;
}
* { box-sizing: border-box; }
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  color: #fff;
  overflow-x: hidden;
}

/* Background with classroom blur */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: url('https://images.unsplash.com/photo-1509062522246-3755977927d7?auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
  filter: blur(5px) brightness(0.65);
  z-index: -1;
}

.container {
  max-width: 1200px;
  margin: 40px auto;
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(8px);
  border-radius: 18px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  padding: 20px 30px;
  color: #fff;
  text-shadow: 0 1px 3px rgba(0,0,0,0.6);
}

h1, h3, label, strong {
  color: #fff;
  text-shadow: 0 2px 6px rgba(0,0,0,0.6);
}

header {
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:16px;
}

h1 { font-size:24px;margin:0; }

/* Transparent frosted buttons */
button {
  background: rgba(255,255,255,0.08);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.25);
  border-radius: 10px;
  padding: 8px 14px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s ease;
  text-shadow: 0 1px 3px rgba(0,0,0,0.7);
}
button:hover {
  box-shadow: 0 0 12px rgba(255,255,255,0.5);
  transform: scale(1.04);
}
button i {
  color: var(--primary);
}
button.warn {
  border-color: rgba(255, 75, 92, 0.4);
  color: #fff;
}
button.warn i {
  color: var(--danger);
}
button.ghost {
  background: rgba(255,255,255,0.05);
  border-color: rgba(255,255,255,0.2);
  color: #fff;
}

.flex { display: flex; flex-wrap: wrap; gap: 20px; }
.left, .right { flex: 1; min-width: 320px; }

.card {
  background: rgba(255,255,255,0.08);
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.12);
  padding: 16px;
  margin-bottom: 16px;
  color: #fff;
}

input, select, textarea {
  width: 100%;
  border: none;
  border-radius: 8px;
  padding: 10px;
  margin-top: 6px;
  font-size: 15px;
  background: rgba(255,255,255,0.15);
  color: #fff;
  font-weight: 500;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

.choice-pill {
  display: inline-block;
  color: #fff;
  padding: 4px 12px;
  border-radius: 999px;
  margin-right: 6px;
  font-weight: bold;
  font-size: 14px;
  box-shadow: 0 0 8px rgba(255,255,255,0.2);
  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}
.choice-A { background: var(--choiceA); }
.choice-B { background: var(--choiceB); }
.choice-C { background: var(--choiceC); color:#111; }
.choice-D { background: var(--choiceD); color:#111; }

.kit-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,0.06);
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
}

.small { font-size: 13px; opacity: 0.95; }

.icon-only {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:34px;
  height:34px;
  border-radius:8px;
  background:rgba(255,255,255,0.06);
  color:#fff;
  border:1px solid rgba(255,255,255,0.06);
}

@media(max-width:768px){
  header { flex-direction:column;align-items:flex-start;gap:8px }
}
</style>
</head>
<body>

<div class="container">
  <header>
    <div>
      <h1><i class="fa-solid fa-pen-to-square"></i> Create & Assign Kit</h1>
      <div class="small">Logged in as <strong id="currentUserDisplay"></strong></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button onclick="goDashboard()"><i class="fa-solid fa-house"></i> Dashboard</button>
      <button onclick="reloadPage()"><i class="fa-solid fa-rotate-right"></i> Reload</button>
      <button onclick="saveKit()"><i class="fa-solid fa-save"></i> Save</button>
    </div>
  </header>

  <div class="flex">
    <!-- LEFT SIDE -->
    <section class="left">
      <div class="card">
        <label for="kitTitle">Kit Title</label>
        <input id="kitTitle" placeholder="Enter kit title...">

        <div style="margin-top:10px;">
          <button onclick="document.getElementById('fileInput').click()">
            <i class="fa-solid fa-file-word"></i> Upload .docx
          </button>
          <input type="file" id="fileInput" accept=".docx" style="display:none;">
        </div>

        <div style="margin-top:10px;">
          <button class="ghost" onclick="toggleManualInput()">
            <i class="fa-solid fa-hand"></i> Add Question Manually
          </button>
          <div id="manualInput" style="display:none; margin-top:10px;">
            <textarea id="manualQuestion" placeholder="Question text..."></textarea>
            <input id="choiceA" placeholder="Choice A">
            <input id="choiceB" placeholder="Choice B">
            <input id="choiceC" placeholder="Choice C">
            <input id="choiceD" placeholder="Choice D">
            <select id="correctAnswer">
              <option value="">Select correct answer</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button onclick="addManualQuestion()"><i class="fa-solid fa-plus"></i> Add Question</button>
              <button class="ghost" onclick="clearManual()">Clear</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3><i class="fa-solid fa-eye"></i> Preview Questions</h3>
        <div id="questions" class="small">No questions yet.</div>
      </div>
    </section>

    <!-- RIGHT SIDE -->
    <section class="right">
      <div class="card">
        <h3><i class="fa-solid fa-list"></i> My Kits</h3>
        <div id="assignedKits" class="small">No kits yet.</div>
      </div>
    </section>
  </div>
</div>

<script>
/* ---------- JS Logic (same as your version) ---------- */
const STORAGE_KEY_KITS = 'userKits_v4';
const STORAGE_KEY_USER = 'loggedInUser';
let currentUser = null;
let workingQuestions = [];
let editingQuestionIndex = null;

function $(id){ return document.getElementById(id); }
function safeParse(s, fallback){ try{ return JSON.parse(s); }catch(e){return fallback;} }

function ensureUser(){
  currentUser = localStorage.getItem(STORAGE_KEY_USER);
  if(!currentUser){
    const name = prompt('No logged-in user found. Enter username to continue (saved locally):');
    if(!name){ alert('A username is required.'); throw new Error('No user'); }
    currentUser = name.trim();
    localStorage.setItem(STORAGE_KEY_USER, currentUser);
  }
  $('currentUserDisplay').textContent = currentUser;
}
ensureUser();

function toggleManualInput(){ const el = $('manualInput'); el.style.display = el.style.display === 'none' ? 'block' : 'none'; }
function clearManual(){ ['manualQuestion','choiceA','choiceB','choiceC','choiceD'].forEach(id=>$(id).value=''); $('correctAnswer').value=''; editingQuestionIndex = null; }

function addManualQuestion(){
  const q = $('manualQuestion').value.trim();
  const a = $('choiceA').value.trim();
  const b = $('choiceB').value.trim();
  const c = $('choiceC').value.trim();
  const d = $('choiceD').value.trim();
  const correct = $('correctAnswer').value;
  if(!q || !a || !b || !c || !d || !correct){ alert('Please complete all fields.'); return; }

  const item = { question: q, choices: [a,b,c,d], correct };
  if(editingQuestionIndex !== null){
    workingQuestions[editingQuestionIndex] = item;
    editingQuestionIndex = null;
  } else {
    workingQuestions.push(item);
  }
  clearManual();
  renderQuestions();
}

function renderQuestions(){
  const container = $('questions');
  container.innerHTML = '';
  if(!workingQuestions.length){ container.textContent = 'No questions yet.'; return; }

  workingQuestions.forEach((q,i)=>{
    const div = document.createElement('div');
    div.className = 'card';
    const correctClass = q.correct === 'A' ? 'choice-A' : q.correct === 'B' ? 'choice-B' : q.correct === 'C' ? 'choice-C' : 'choice-D';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
        <div style="max-width:78%">
          <div style="font-weight:800">Q${i+1}. ${escapeHtml(q.question)}</div>
          <div style="margin-top:8px">
            <div><span class="choice-pill choice-A">A</span> ${escapeHtml(q.choices[0]||'')}</div>
            <div><span class="choice-pill choice-B">B</span> ${escapeHtml(q.choices[1]||'')}</div>
            <div><span class="choice-pill choice-C">C</span> ${escapeHtml(q.choices[2]||'')}</div>
            <div><span class="choice-pill choice-D">D</span> ${escapeHtml(q.choices[3]||'')}</div>
          </div>
          <div style="margin-top:8px;font-size:13px"><strong>Answer:</strong> <span class="${correctClass} small" style="padding:6px 8px;border-radius:8px">${q.correct}</span></div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="ghost" title="Edit" onclick="editQuestion(${i})"><i class="fa-solid fa-pen"></i> Edit</button>
          <button class="warn" title="Delete" onclick="deleteQuestion(${i})"><i class="fa-solid fa-trash"></i> Delete</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

function editQuestion(index){
  const q = workingQuestions[index];
  if(!q) return;
  $('manualQuestion').value = q.question || '';
  $('choiceA').value = q.choices[0] || '';
  $('choiceB').value = q.choices[1] || '';
  $('choiceC').value = q.choices[2] || '';
  $('choiceD').value = q.choices[3] || '';
  $('correctAnswer').value = q.correct || '';
  editingQuestionIndex = index;
  $('manualInput').style.display = 'block';
  window.scrollTo({top:0,behavior:'smooth'});
}
function deleteQuestion(index){
  if(!confirm('Delete this question?')) return;
  workingQuestions.splice(index,1);
  renderQuestions();
}

function loadAllKits(){ return safeParse(localStorage.getItem(STORAGE_KEY_KITS), {}); }
function saveAllKits(all){ localStorage.setItem(STORAGE_KEY_KITS, JSON.stringify(all)); }

function saveKit(){
  if(!workingQuestions.length){ alert('Add at least one question before saving a kit.'); return; }
  const title = $('kitTitle').value.trim() || 'Untitled Kit';
  const all = loadAllKits();
  if(!all[currentUser]) all[currentUser] = [];
  const kit = { kitId: Date.now().toString(), title, questions: JSON.parse(JSON.stringify(workingQuestions)), code: null, active: false, createdAt: new Date().toISOString() };
  all[currentUser].push(kit);
  saveAllKits(all);
  workingQuestions = [];
  $('kitTitle').value = '';
  renderQuestions();
  loadAssignedKits();
  setTimeout(()=> alert('Kit saved!'), 50);
}

function loadAssignedKits(){
  const out = $('assignedKits'); out.innerHTML = '';
  const all = loadAllKits();
  const kits = all[currentUser] || [];
  if(!kits.length){ out.textContent = 'No kits yet.'; return; }
  kits.slice().reverse().forEach(k=>{
    const row = document.createElement('div'); row.className = 'kit-row';
    row.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(90deg,var(--primary),#4facfe);display:flex;align-items:center;justify-content:center;font-weight:800">${escapeHtml((k.title||'K')[0].toUpperCase())}</div>
        <div>
          <div class="kit-title" style="font-weight:800">${escapeHtml(k.title||'Untitled')}</div>
          <div class="small">${(k.questions || []).length} question(s) ${k.code ? 'â€¢ Code: ' + escapeHtml(k.code) : ''}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button title="Assign / Generate Code" onclick="toggleAssign('${k.kitId}')"><i class="fa-solid fa-link"></i> ${k.active ? 'Unassign' : 'Assign'}</button>
        <button title="Edit kit" class="ghost" onclick="loadKitToEditor('${k.kitId}')"><i class="fa-solid fa-pen"></i></button>
        <button title="Export kit" class="ghost" onclick="exportKit('${k.kitId}')"><i class="fa-solid fa-file-export"></i></button>
        <button title="Delete kit" class="warn" onclick="deleteKit('${k.kitId}')"><i class="fa-solid fa-trash"></i></button>
      </div>
    `;
    out.appendChild(row);
  });
}

function generateCode(existing){
  let tries=0;
  while(tries < 200){
    const c = 'EZ' + Math.floor(1000 + Math.random()*9000);
    if(!existing.includes(c)) return c;
    tries++;
  }
  return 'EZ' + Math.floor(Math.random()*900000);
}

function toggleAssign(kitId){
  const all = loadAllKits();
  const kits = all[currentUser] || [];
  const kit = kits.find(k => k.kitId === kitId);
  if(!kit){ alert('Kit not found'); return; }

  if(!kit.active){
    const allKits = Object.values(all).flat();
    const used = allKits.map(x => x.code).filter(Boolean);
    kit.code = generateCode(used);
    kit.active = true;
    kit.assignedAt = new Date().toISOString();
    alert('Assigned code: ' + kit.code);
  } else {
    kit.active = false;
    kit.unassignedAt = new Date().toISOString();
    alert('Kit unassigned: ' + (kit.code || 'n/a'));
  }
  kit.updatedAt = new Date().toISOString();
  saveAllKits(all);
  loadAssignedKits();
}

function loadKitToEditor(kitId){
  const all = loadAllKits();
  const kit = (all[currentUser] || []).find(k => k.kitId === kitId);
  if(!kit) return alert('Kit not found');
  $('kitTitle').value = kit.title || '';
  workingQuestions = JSON.parse(JSON.stringify(kit.questions || []));
  renderQuestions();
  window.scrollTo({top:0,behavior:'smooth'});
}

function exportKit(kitId){
  const all = loadAllKits();
  const kit = (all[currentUser] || []).find(k => k.kitId === kitId);
  if(!kit){ alert('Kit not found'); return; }
  const data = JSON.stringify(kit, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${kit.title || 'kit'}.json`;
  a.click();
}

function deleteKit(kitId){
  if(!confirm('Delete this kit permanently?')) return;
  const all = loadAllKits();
  all[currentUser] = (all[currentUser] || []).filter(k => k.kitId !== kitId);
  saveAllKits(all);
  loadAssignedKits();
}

function goDashboard(){ window.location.href = 'dashboard.html'; }
function reloadPage(){ location.reload(); }
function escapeHtml(str){ return str ? str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ''; }

loadAssignedKits();
</script>
</body>
</html>
