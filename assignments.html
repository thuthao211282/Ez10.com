<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create & Assign Kit | Ez10</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
<style>
body {
  font-family: 'Poppins', sans-serif;
  margin:0; padding:0;
  min-height:100vh;
  display:flex; justify-content:center; align-items:center;
  background: url('https://images.unsplash.com/photo-1523240795612-9a054b0db644?auto=format&fit=crop&w=1600&q=80') no-repeat center center fixed;
  background-size: cover; color:#333;
}
body::before {
  content:''; position:fixed; top:0; left:0; right:0; bottom:0; backdrop-filter: blur(8px);
}
.container {
  backdrop-filter: blur(25px);
  background: rgba(255,255,255,0.85);
  border-radius:25px; box-shadow:0 8px 25px rgba(0,0,0,0.3);
  width:90%; max-width:850px; padding:30px; color:#222; text-align:center; position:relative; z-index:1;
}
h1 { font-size:32px; margin-bottom:20px; color:#007bff; text-shadow:0 0 4px rgba(255,255,255,0.8);}
button {border:none; border-radius:30px; padding:12px 26px; margin:6px; font-size:16px; font-weight:600; color:white; cursor:pointer; background:#007bff; transition:all 0.3s; }
button:hover {transform:scale(1.05);}
input, select {width:100%; padding:12px; margin:8px 0; border-radius:12px; border:1px solid #ccc; outline:none; background:rgba(255,255,255,0.9);}
.question-card {background: rgba(255,255,255,0.85); border-radius:18px; padding:20px; margin:15px 0; text-align:left; position:relative; box-shadow:0 4px 15px rgba(0,0,0,0.15); transition:all 0.3s ease;}
.delete-btn {position:absolute; top:15px; right:15px; background:#ff4b4b; color:white; border-radius:50%; width:35px; height:35px; border:none; cursor:pointer; display:flex; justify-content:center; align-items:center;}
.delete-btn:hover {background:#ff1e1e;}
.choice {margin:5px 0;}
.choice span {font-weight:500;}
#assignCode {margin-top:10px; font-size:22px; font-weight:bold; color:#007bff; transition: all 0.4s ease;}
.fade-in {animation: fadeIn 0.5s ease forwards;}
@keyframes fadeIn {from{opacity:0; transform:scale(0.9);} to{opacity:1; transform:scale(1);} }
.status-badge {
  display:inline-block;
  padding:5px 12px;
  border-radius:20px;
  font-size:13px;
  font-weight:600;
  color:white;
}
.active {background:#28a745;}
.inactive {background:#6c757d;}
#assignCode {
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.4s ease;
}
#assignCode.fade-in {
  opacity: 1;
  transform: translateY(0);
}

</style>
</head>
<body>
<div class="container">
  <h1><i class="fa-solid fa-pen-to-square"></i> Create & Assign Kit</h1>

  <div>
    <button onclick="window.location.href='main.html'"><i class="fa-solid fa-house"></i> Dashboard</button>
  </div>

  <div>
    <button onclick="document.getElementById('fileInput').click()"><i class="fa-solid fa-upload"></i> Upload Word</button>
    <button onclick="toggleManualInput()"><i class="fa-solid fa-hand"></i> Add by Hand</button>
    <input type="file" id="fileInput" accept=".docx" style="display:none;">
  </div>

  <div id="manualInput" style="display:none;">
    <input id="manualQuestion" placeholder="Enter question...">
    <input id="choiceA" placeholder="Choice A">
    <input id="choiceB" placeholder="Choice B">
    <input id="choiceC" placeholder="Choice C">
    <input id="choiceD" placeholder="Choice D">
    <select id="correctAnswer">
      <option value="">Select Correct Answer</option>
      <option value="A">A</option><option value="B">B</option>
      <option value="C">C</option>
      <option value="D">D</option>
    </select>
    <button onclick="addManualQuestion()"><i class="fa-solid fa-plus"></i> Add</button>
  </div>

  <div id="questions"></div>

  <div>
    <button onclick="saveKit()"><i class="fa-solid fa-save"></i> Save</button>
  </div>
  <div id="assignCode" class="fade-in"></div>

  <h2>My Kits</h2>
  <div id="assignedKits"></div>

</div>

<script>
let currentUser = localStorage.getItem('loggedInUser');
if(!currentUser){ alert('You must log in!'); window.location.href='login.html'; }
let questions = [];

// --- Word Upload ---
document.getElementById('fileInput').addEventListener('change', async e=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const buffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({arrayBuffer:buffer});
    parseQuestions(result.value);
  } catch { alert('Error reading Word file'); }
});

function parseQuestions(text){
  const lines = text.split('\n').map(x=>x.trim()).filter(x=>x);
  questions=[]; let q=null;
  lines.forEach(line=>{
    if(/^Q\d*/i.test(line)){
      if(q) questions.push(q);
      q={question:line.replace(/^Q\d*[:.\-\s]*/i,''), choices:[]};
    } else if(/^[A-D][\.\)]/.test(line)){
      q?.choices.push(line.replace(/^[A-D][\.\)]\s*/,'')); 
    } else if(/^Answer[:\-]?\s*[A-D]/i.test(line)){
      q.correct=line.match(/[A-D]/i)[0].toUpperCase();
    }
  });
  if(q) questions.push(q);
  renderQuestions();
}

function toggleManualInput(){
  const block=document.getElementById('manualInput');
  block.style.display = block.style.display==='none'?'block':'none';
}

function addManualQuestion(){
  const q=document.getElementById('manualQuestion').value.trim();
  const a=document.getElementById('choiceA').value.trim();
  const b=document.getElementById('choiceB').value.trim();
  const c=document.getElementById('choiceC').value.trim();
  const d=document.getElementById('choiceD').value.trim();
  const correct=document.getElementById('correctAnswer').value;
  if(!q||!a||!b||!c||!d||!correct){ alert('Fill all fields'); return; }
  questions.push({question:q,choices:[a,b,c,d],correct});
  renderQuestions();
  ['manualQuestion','choiceA','choiceB','choiceC','choiceD'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('correctAnswer').value='';
}

function renderQuestions(){
  const qDiv=document.getElementById('questions');
  qDiv.innerHTML='';
  questions.forEach((q,i)=>{
    const card=document.createElement('div'); card.className='question-card fade-in';
    card.innerHTML=`
      <button class="delete-btn" onclick="deleteQuestion(${i})"><i class="fa-solid fa-trash"></i></button>
      <strong>Q${i+1}:</strong> ${q.question} <br>
      <div class="choice"><span>A)</span> ${q.choices[0]}</div>
      <div class="choice"><span>B)</span> ${q.choices[1]}</div>
      <div class="choice"><span>C)</span> ${q.choices[2]}</div>
      <div class="choice"><span>D)</span> ${q.choices[3]}</div>
      <strong>Answer:</strong> ${q.correct}
    `;
    qDiv.appendChild(card);
  });
}

function deleteQuestion(i){ 
  if(confirm('Delete this question?')){ 
    questions.splice(i,1); renderQuestions(); 
  } 
}

// --- Save Kit ---
function saveKit(){
  if(questions.length===0){ alert('Add questions first'); return; }
  let all = JSON.parse(localStorage.getItem('userKits')||'{}');
  if(!all[currentUser]) all[currentUser]=[];
  all[currentUser].push({questions:[...questions], code:null, active:false});
  localStorage.setItem('userKits', JSON.stringify(all));
  alert('Kit saved successfully!');
  questions=[]; renderQuestions();
  loadAssignedKits();
}

// --- Assign & Unassign Kit ---
function toggleAssign(code) {
  let all = JSON.parse(localStorage.getItem('userKits') || '{}');
  const kits = all[currentUser] || [];

  // Find kit by code, or pick first unassigned if no code yet
  let kit = kits.find(k => k.code === code);
  if (!kit && (!code || code === '')) {
    kit = kits.find(k => !k.code);
  }

  if (!kit) {
    alert('Kit not found!');
    return;
  }

  if (!kit.active) { // Assign
    const newCode = 'KIT' + Math.floor(10000 + Math.random() * 90000);
    kit.code = newCode;
    kit.active = true;
    const codeDiv = document.getElementById('assignCode');
    codeDiv.textContent = 'ðŸŽ¯ Kit Code: ' + newCode;
    codeDiv.classList.remove('fade-in'); // reset animation
    void codeDiv.offsetWidth; // trigger reflow
    codeDiv.classList.add('fade-in');
  } else { // Unassign
    kit.active = false;
    const codeDiv = document.getElementById('assignCode');
    codeDiv.textContent = 'Kit ' + kit.code + ' unassigned.';
    codeDiv.classList.remove('fade-in');
    void codeDiv.offsetWidth;
    codeDiv.classList.add('fade-in');
  }

  all[currentUser] = kits;
  localStorage.setItem('userKits', JSON.stringify(all));
  loadAssignedKits();
}


// --- Delete Kit ---
function deleteKit(code){
  if(!confirm('Are you sure you want to delete this kit permanently?')) return;
  let all = JSON.parse(localStorage.getItem('userKits')||'{}');
  if(!all[currentUser]) return;
  all[currentUser] = all[currentUser].filter(k => k.code !== code && !(k.code===null && !code));
  localStorage.setItem('userKits', JSON.stringify(all));
  loadAssignedKits();
}

// --- Load Kits ---
function loadAssignedKits(){
  const div=document.getElementById('assignedKits'); 
  div.innerHTML='';
  let all = JSON.parse(localStorage.getItem('userKits')||'{}');
  if(!all[currentUser]) return;
  all[currentUser].forEach(k=>{
    const card=document.createElement('div'); card.className='question-card fade-in';
    card.innerHTML=`
      <strong>Code:</strong> ${k.code||'Not assigned'} <br>
      <span class="status-badge ${k.active?'active':'inactive'}">${k.active?'Active':'Inactive'}</span><br><br>
      <button style="background:${k.active?'#6c757d':'#28a745'}" onclick="toggleAssign('${k.code||''}')">
        ${k.active?'Unassign':'Assign'}
      </button>
      <button onclick="editKit('${k.code||''}')"><i class="fa-solid fa-pen"></i> Edit</button>
      <button style="background:#dc3545" onclick="deleteKit('${k.code||''}')"><i class="fa-solid fa-trash"></i> Delete</button>
    `;
    div.appendChild(card);
  });
}

// --- Edit Kit ---
function editKit(code){
  let all = JSON.parse(localStorage.getItem('userKits')||'{}');
  const kit = (all[currentUser]||[]).find(k=>k.code===code || !k.code);
  if(!kit){ alert('Kit not found'); return; }
  questions=[...kit.questions];
  renderQuestions();
}

loadAssignedKits();
</script>

</body>
</html>
